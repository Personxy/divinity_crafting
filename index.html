<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="神界：原罪（增强版）合成配方表（中文）" />
  <title>神界：原罪（增强版）合成配方表</title>

  <link rel="stylesheet" href="default.css" />
</head>

<body>
  <div class="theme-selector">
    <button class="btn btn-xs light">亮色</button>
    <button class="dark btn btn-xs">暗色</button>
  </div>

  <div class="container-fluid">
    <div class="top-info">
      <h1>神界：原罪（增强版）合成配方表（中文）</h1>
      <p>
        支持搜索与排序：在下方搜索框输入关键字过滤结果，点击表头进行排序，右上角可切换亮色/暗色主题。
      </p>
      <h4>提示</h4>
      <ul>
        <li>如果某些词条与游戏内中文不一致，可编辑 translation_map.zh-CN.json 并重新生成。</li>
        <li>本页面数据来自 recipe_list.zh-CN.json。</li>
      </ul>
    </div>

    <div id="filter">
      <label for="recipeSearch">筛选：</label>
      <input type="search" id="recipeSearch" />
      <label for="typeFilter" style="margin-left: 10px">类别：</label>
      <select id="typeFilter"></select>
      <button id="resetFilters" class="btn btn-default btn-sm" style="margin-left: 10px">重置</button>
    </div>

    <table id="recipeTable" style="text-align: center" class="table">
      <thead>
        <tr class="table-head">
          <th data-key="result">结果</th>
          <th data-key="type">类别</th>
          <th data-key="part1">材料 1</th>
          <th data-key="part2">材料 2</th>
          <th data-key="skill">技能</th>
          <th data-key="level">等级</th>
        </tr>
      </thead>
      <tbody id="recipeBody"></tbody>
    </table>
  </div>

  <script>
    const darkButton = document.querySelector(".dark");
    const lightButton = document.querySelector(".light");
    const recipeSearch = document.querySelector("#recipeSearch");
    const typeFilter = document.querySelector("#typeFilter");
    const resetFilters = document.querySelector("#resetFilters");
    const recipeBody = document.querySelector("#recipeBody");
    const headers = Array.from(document.querySelectorAll("th[data-key]"));

    const state = {
      recipes: [],
      query: "",
      type: "",
      sortKey: "result",
      sortDir: 1,
    };

    function setTheme(mode) {
      if (mode === "dark") {
        document.querySelector(".table").classList.add("table-dark");
        document.body.style.backgroundColor = "#333";
        document.body.style.color = "#fff";
        return;
      }
      document.querySelector(".table").classList.remove("table-dark");
      document.body.style.backgroundColor = "#fff";
      document.body.style.color = "#000";
    }

    function normalizeRecipes(recipes) {
      return recipes.map((r) => ({
        result: r["Result"] ?? "",
        type: r["Recipe Type"] ?? "",
        part1: r["Part 1"] ?? "",
        part2: r["Part 2"] ?? "",
        skill: r["Skill"] ?? "",
        level: r["Level"] ?? "",
      }));
    }

    function rowMatchesQuery(row, query) {
      if (!query) return true;
      const q = query.trim();
      if (!q) return true;
      const haystack = `${row.result} ${row.type} ${row.part1} ${row.part2} ${row.skill} ${row.level}`;
      return haystack.includes(q);
    }

    function rowMatchesType(row, type) {
      if (!type) return true;
      return row.type === type;
    }

    function compare(a, b, key) {
      const av = a[key] ?? "";
      const bv = b[key] ?? "";
      if (key === "level") return Number(av) - Number(bv);
      return String(av).localeCompare(String(bv), "zh-Hans-CN");
    }

    function fillTypeOptions(recipes) {
      const types = Array.from(new Set(recipes.map((r) => r.type).filter(Boolean))).sort((a, b) =>
        a.localeCompare(b, "zh-Hans-CN"),
      );
      const options = [{ value: "", label: "全部" }, ...types.map((t) => ({ value: t, label: t }))];
      typeFilter.replaceChildren(
        ...options.map((o) => {
          const opt = document.createElement("option");
          opt.value = o.value;
          opt.textContent = o.label;
          return opt;
        }),
      );
      typeFilter.value = state.type;
    }

    function render() {
      const filtered = state.recipes.filter((r) => rowMatchesQuery(r, state.query) && rowMatchesType(r, state.type));
      filtered.sort((a, b) => state.sortDir * compare(a, b, state.sortKey));
      recipeBody.replaceChildren(
        ...filtered.map((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.result}</td><td>${r.type}</td><td>${r.part1}</td><td>${r.part2}</td><td>${r.skill}</td><td>${r.level}</td>`;
          return tr;
        }),
      );
    }

    headers.forEach((th) => {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-key");
        if (!key) return;
        if (state.sortKey === key) state.sortDir = -state.sortDir;
        else {
          state.sortKey = key;
          state.sortDir = 1;
        }
        render();
      });
    });

    recipeSearch.addEventListener("input", (e) => {
      state.query = e.target.value ?? "";
      render();
    });

    typeFilter.addEventListener("change", (e) => {
      state.type = e.target.value ?? "";
      render();
    });

    resetFilters.addEventListener("click", () => {
      state.query = "";
      state.type = "";
      state.sortKey = "result";
      state.sortDir = 1;
      recipeSearch.value = "";
      typeFilter.value = "";
      render();
    });

    darkButton.addEventListener("click", () => setTheme("dark"));
    lightButton.addEventListener("click", () => setTheme("light"));

    setTheme("light");
    fetch("recipe_list.zh-CN.json")
      .then((resp) => resp.json())
      .then((recipes) => {
        state.recipes = normalizeRecipes(recipes);
        fillTypeOptions(state.recipes);
        render();
      })
      .catch(() => {
        state.recipes = [];
        fillTypeOptions(state.recipes);
        render();
      });
  </script>
</body>

</html>